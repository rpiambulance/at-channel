<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: handlers/slashCommands.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: handlers/slashCommands.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>//node packages
const md5 = require("md5");
const emojiRegex = require("emoji-regex")();

//local packages
const {
  app: {
    client: {
      chat: { postEphemeral, postMessage }
    }
  }
} = require("../utilities/bolt.js");
const { sendForApproval, postToChannel } = require("./message.js");
const { randomEmoji } = require("../utilities/helperFunctions");
//globals
const TOKEN = process.env.SLACK_BOT_TOKEN;

/**
 * Handles /channel commands: first determines if the request is blank. If so, it lets the
 * requester know as much. Next, was the request sent in a moderated channel? If so, the
 * message is sent to the moderation channel for approval, and an ephemeral message is
 * posted to the requester to inform them of this. If the message was sent to a
 * non-moderated channel, the message is immediately sent to said channel.
 *
 * @param {string} channel_name - Slack channel name, such as "general" (no # character)
 * @param {string} channel_id - Slack channel ID, such as "CFCP42RL7" (without &lt;, >, or #
 * characters)
 * @param {string} user_id - Slack user ID (without &lt;, >, or # characters)
 * @param {string} text - Message that was requested
 */
const slashChannel = async ({
  command: { channel_name, channel_id, user_id, text }
}) => {
  text = text.replace(emojiRegex, "");
  if (text == "" || text == "&amp;gt;" || text == "&amp;gt;&amp;gt;&amp;gt;") {
    postEphemeral({
      token: TOKEN,
      channel: channel_id,
      user: user_id,
      text:  randomEmoji("medium") + " Maybe try actually writing something?"
    });
    return;
  }
  //determine if we are in a moderated channel, otherwise post automatically.
  switch (channel_name) {
    case "general":
    case "alerts":
    case "random":
    case "scheduling":
      // send request to the moderation channel
      const requestId = await sendForApproval(
        text,
        channel_id,
        user_id,
        md5(text)
      );
      // post emphemeral to user in active channel
      postEphemeral({
        token: TOKEN,
        channel: channel_id,
        user: user_id,
        text:
          randomEmoji("happy") + " Thanks for your request! It's been sent to the moderators for approval."
      });
      // post Slackbot message to user to allow for cancellation of request
      postMessage({
        token: TOKEN,
        channel: user_id,
        user: user_id,
        text: "Your message has been sent to the moderators for approval.",
        blocks: [
          {
            type: "section",
            text: {
              type: "mrkdwn",
              text: `You requsted an at-channel messasge to be sent to &lt;#${channel_id}>. It has been sent to the moderators for approval.\nYou wrote:\n>>>${text}`
            }
          },
          {
            type: "divider"
          },
          {
            type: "section",
            text: {
              type: "mrkdwn",
              text: "*Want to cancel your message?*"
            }
          },
          {
            type: "actions",
            elements: [
              {
                type: "button",
                text: {
                  type: "plain_text",
                  text: "Cancel @channel request"
                },
                style: "danger",
                action_id: `CAN_${requestId}`
              }
            ]
          }
        ]
      });
      break;
    default:
    // if not a moderated channel, simply most the message immediately
      postToChannel(channel_id, text, user_id);
  }
};

module.exports = { slashChannel };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#approveMessage">approveMessage</a></li><li><a href="global.html#approveNoAt">approveNoAt</a></li><li><a href="global.html#cancelRequest">cancelRequest</a></li><li><a href="global.html#isModerator">isModerator</a></li><li><a href="global.html#postToChannel">postToChannel</a></li><li><a href="global.html#randomEmoji">randomEmoji</a></li><li><a href="global.html#rejectMessage">rejectMessage</a></li><li><a href="global.html#sendForApproval">sendForApproval</a></li><li><a href="global.html#sendRejectionDm">sendRejectionDm</a></li><li><a href="global.html#slashChannel">slashChannel</a></li><li><a href="global.html#updateModMessage">updateModMessage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Sat Apr 18 2020 11:11:21 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
